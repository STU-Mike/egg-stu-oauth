<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>授权码模式 | stu-oauth</title>
    <meta name="description" content="课程表开放平台">
    <link rel="icon" href="/egg-stu-oauth/favicon.jpg">
    
    <link rel="preload" href="/egg-stu-oauth/assets/css/0.styles.509056b9.css" as="style"><link rel="preload" href="/egg-stu-oauth/assets/js/app.e7137f6d.js" as="script"><link rel="preload" href="/egg-stu-oauth/assets/js/6.90852aaa.js" as="script"><link rel="prefetch" href="/egg-stu-oauth/assets/js/2.566ce1ec.js"><link rel="prefetch" href="/egg-stu-oauth/assets/js/3.589ffedc.js"><link rel="prefetch" href="/egg-stu-oauth/assets/js/4.14c4d8ef.js"><link rel="prefetch" href="/egg-stu-oauth/assets/js/5.1c1097a7.js"><link rel="prefetch" href="/egg-stu-oauth/assets/js/7.45984ac5.js"><link rel="prefetch" href="/egg-stu-oauth/assets/js/8.5c74e5bb.js"><link rel="prefetch" href="/egg-stu-oauth/assets/js/9.d93e2f94.js">
    <link rel="stylesheet" href="/egg-stu-oauth/assets/css/0.styles.509056b9.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/egg-stu-oauth/" class="home-link router-link-active"><!----> <span class="site-name">stu-oauth</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/egg-stu-oauth/" class="nav-link">首页</a></div><div class="nav-item"><a href="/egg-stu-oauth/guide/介绍.html" class="nav-link">指南</a></div><div class="nav-item"><a href="/egg-stu-oauth/theory/中间件.html" class="nav-link">框架原理</a></div><div class="nav-item"><a href="https://git.code.tencent.com/stu-syllabus/mini-pro-framework" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Git
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/egg-stu-oauth/" class="nav-link">首页</a></div><div class="nav-item"><a href="/egg-stu-oauth/guide/介绍.html" class="nav-link">指南</a></div><div class="nav-item"><a href="/egg-stu-oauth/theory/中间件.html" class="nav-link">框架原理</a></div><div class="nav-item"><a href="https://git.code.tencent.com/stu-syllabus/mini-pro-framework" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Git
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading open"><span>指南</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/egg-stu-oauth/guide/介绍.html" class="sidebar-link">介绍</a></li><li><a href="/egg-stu-oauth/guide/授权码模式.html" class="active sidebar-link">授权码模式</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/egg-stu-oauth/guide/授权码模式.html#授权流程" class="sidebar-link">授权流程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/egg-stu-oauth/guide/授权码模式.html#核心流程" class="sidebar-link">核心流程</a></li></ul></li><li class="sidebar-sub-header"><a href="/egg-stu-oauth/guide/授权码模式.html#认证参数" class="sidebar-link">认证参数</a></li><li class="sidebar-sub-header"><a href="/egg-stu-oauth/guide/授权码模式.html#安全性" class="sidebar-link">安全性</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/egg-stu-oauth/guide/授权码模式.html#state作用" class="sidebar-link">state作用</a></li></ul></li></ul></li><li><a href="/egg-stu-oauth/guide/刷新凭证.html" class="sidebar-link">刷新凭证</a></li><li><a href="/egg-stu-oauth/guide/接口文档.html" class="sidebar-link">接口文档</a></li><li><a href="/egg-stu-oauth/guide/错误码.html" class="sidebar-link">错误码</a></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="授权码模式"><a href="#授权码模式" aria-hidden="true" class="header-anchor">#</a> 授权码模式</h1> <p>我们使用了Oauth2.0的<strong>授权码模式</strong>（authorization code），它是功能最完整、流程最严密的授权模式。</p> <h2 id="授权流程"><a href="#授权流程" aria-hidden="true" class="header-anchor">#</a> 授权流程</h2> <p><img src="/egg-stu-oauth/%E6%8E%88%E6%9D%83%E6%B5%81%E7%A8%8B.jpg" alt="[授权流程]"></p> <p><img src="C:%5CUsers%5C56337%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5C1551193519455.png" alt="1551193519455"></p> <h3 id="核心流程"><a href="#核心流程" aria-hidden="true" class="header-anchor">#</a> 核心流程</h3> <ul><li><p>A. 访问业务服务器接口</p> <p>该接口由第三方应用传入，在服务器中生成<a href="#state%E4%BD%9C%E7%94%A8">state</a>并写入session，组装好授权URL（详见<a href="#%E8%AE%A4%E8%AF%81%E5%8F%82%E6%95%B0">认证参数</a>），并重定向到授权URL</p></li> <li><p>B. 访问授权页面</p> <p>访问授权页面前需要先登录，未登录会重定向到登录页面，如果之前登陆过但没有进行授权，且认证服务器的登录态仍有效，则直接能访问授权页面</p></li> <li><p>C. 重定向到指定url，并带上授权码code</p> <p>重定向的URL是由第三方应用在调起浏览器过程中传入的，认证服务器会在URL的query中在加入code参数和state参数，重定向请求到第三方应用的业务后台，然后从query中取出授权码code和state，比对session的state与query中的state是否一致</p> <ul><li>如果不一致，证明该请求不是来自需要授权的客户端，授权失败，可能遭到CSRF攻击</li></ul></li> <li><p>D. code换取用去用户凭证token</p> <p>业务后台拿到授权码后，需要请求认证服务器换取登录凭证token，token可用于调用开放平台所提供的服务</p></li> <li><p>E. 授权成功，返回业务后台登录态</p> <p>授权成功后，业务后台需要根据自身需求，管理用户的登录态，并给客户端返回自身后台的登录态</p></li> <li><p>F. 获取业务后台登录态，退出浏览器</p> <p>第三方应用客户端获取到登录态，并退出浏览器</p></li></ul> <h2 id="认证参数"><a href="#认证参数" aria-hidden="true" class="header-anchor">#</a> 认证参数</h2> <p>该部分参数是业务后台组装，以下为GET请求重query所带的参数：</p> <ul><li>response_type：表示授权类型，必选项，此处的值固定为&quot;code&quot;</li> <li>client_id：表示客户端的ID，必选项</li> <li>redirect_uri：表示重定向URI，填业务后台的相关接口URL，可选项</li> <li>scope：表示申请的权限范围，可选项</li> <li>state：表示客户端的当前状态，可以指定任意值，认证服务器会原封不动地返回这个值，用于防止CSRF。</li></ul> <h2 id="安全性"><a href="#安全性" aria-hidden="true" class="header-anchor">#</a> 安全性</h2> <ul><li>用户无需在第三方APP输入账号密码，进行登录的流程在开放平台所提供的登录页面完成</li> <li>附带code的重定向URL，必须在开放平台登记，不能为任意URL，确保code被送到第三方应用的后台服务器</li> <li>校验session的state与query中的state必须一致，否则拒绝授权，详见<a href="#state%E4%BD%9C%E7%94%A8">state作用</a></li></ul> <p>更多Oauth安全性可以到网上查找资料</p> <p><a href="https://www.chrisyue.com/security-issue-about-oauth-2-0-you-should-know.html" target="_blank" rel="noopener noreferrer">关于 OAuth2.0 安全性你应该要知道的一些事<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，这篇文章说得比较全，但得花点时间看</p> <h3 id="state作用"><a href="#state作用" aria-hidden="true" class="header-anchor">#</a> state作用</h3> <p>state参数，是由业务后台动态生成的唯一的随机值，这样确保了，不同的客户端，都拥有着不同的state。将请求加密放入session中，然后跟认证后台重定向后的state进行比对，一致才能确保授权请求来源于同一个客户端。</p> <p>如果没有state参数，举个可能的攻击例子：</p> <ol><li>用户A在点击授权后，认证服务器将请求重定向到业务后台指定URL，并带上授权码</li> <li>黑客B通过技术手段截取了用户A的重定向请求</li> <li>黑客B在自己客户端发起重定向URL的请求</li> <li>用户A的授权被黑客B窃取。</li></ol> <p>业务后台服务器没有办法知道重定向过来的请求，是否为用户A发出的</p> <p>如果加入了state参数，在业务后台组装授权URL时，会给用户浏览器设置带有state的session，用户每次向业务后台发送请求，都会带上该session。在用户A在请求业务后台时，业务后台能从cookie中取出session，而黑客B的客户端发起的请求，是没有该session的，因此会导致授权失败</p></div> <div class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">4/9/2019, 11:39:51 PM</span></div></div> <!----> </div> <!----></div></div>
    <script src="/egg-stu-oauth/assets/js/app.e7137f6d.js" defer></script><script src="/egg-stu-oauth/assets/js/6.90852aaa.js" defer></script>
  </body>
</html>
